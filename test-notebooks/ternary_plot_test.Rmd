---
title: "Ternary Plot Test"
output: html_notebook
---

## Libraries
```{r}
# devtools::install(
#   "~/Projects/Mastering-DFS-Analytics/dfstools/",
#   build_vignettes = TRUE
# )
library(dfstools)
library(archetypes)
library(DT)
library(tibble)
library(dplyr)
library(vcd)
```

## Get data
```{r}
# playerbox <- playerboxscore("~/Dropbox/16-17-player-data/archive/season-player-feed-04-12-2017.xlsx")
playerbox <- playerboxscore("~/Dropbox/17-wnba-player/wnba-season-player-feed-06-02-2017.xlsx")
```

## Run model
```{r}
arch_search <- archetype_search(playerbox)
screeplot(arch_search$arch_results)
```

## Look at the three-archetype result in detail

### Parallel coordinate plot with the archetypes
```{r}
best_model <- bestModel(arch_search$arch_results[[3]])
archetype_table <- round(t(parameters(best_model)), 1) %>%
  as.data.frame() %>%
  rownames_to_column()
pcplot(best_model, arch_search$arch_input$pbs_summary)
```
### Name the archetypes
```{r}
colnames(archetype_table)[1] <- "Metric"

# The one with the fewest minutes we'll call "Bench"
minutes <- as.vector(filter(archetype_table, Metric == "min"))[2:4]
ixbench <- which.min(minutes) + 1
colnames(archetype_table)[ixbench] <- "Bench"

# The one with the most rebounds we'll call "Rim"
rebounds <- as.vector(filter(archetype_table, Metric == "tot"))[2:4]
ixrim <- which.max(rebounds) + 1
colnames(archetype_table)[ixrim] <- "Rim"

# The one with the most threes we'll call "Arc"
threes <- as.vector(filter(archetype_table, Metric == "x3p"))[2:4]
ixarc <- which.max(threes) + 1
colnames(archetype_table)[ixarc] <- "Arc"

# Show 'em!
datatable(archetype_table, rownames = FALSE, filter = "top")
```
### Player table
```{r}

player_table <- bind_cols(
  arch_search$arch_input$current_team,
  coefficients(best_model, "alphas") %>%
    as.data.frame()
)
colnames(player_table)[4:6] <- colnames(archetype_table)[2:4]
datatable(player_table, rownames = FALSE, filter = "top")
```
## Generate team summary table
```{r}
team_summary <- player_table %>%
  group_by(own_team) %>%
  summarize_if(is.numeric, sum, na.rm = TRUE) %>%
  ungroup() %>%
  arrange(Bench)  
datatable(team_summary, rownames = FALSE, filter = "top")
```

## Generate team plots
```{r}
teams <- sort(unique(as.character(player_table$own_team)))
for (t in teams) {
  team_data <- player_table %>% 
    filter(own_team == t) %>% 
    arrange(desc(1 - Bench))
  pdf(
    file = paste(t, "pdf", sep = "." ),
    width = 8.5,
    height = 8.5
  )
  ternaryplot(
    team_data[, 4:6], 
    id = team_data$player_full_name,
    cex = 0.5, 
    newpage = FALSE, 
    dimnames_color = "red",
    border = "light grey",
    grid_color = "light grey",
    main = t)
  dev.off()
}
```
